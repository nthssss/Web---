# 三次握手四次挥手

---
- TCP中Socket的11种状态变迁：


## TCP连接正常建立和关闭对应的状态：

![](/assets/TCP中Socket正常连接和断开连接状态变迁.png)

TCP中的11种状态已经在此处体现了10种状态（还有一种CLOSING状态在同时关闭时出现）。

TCP正常连接、终止中的报文：

* SYN表示建立连接；
* FIN表示关闭连接；
* ACK表示响应。

## TCP正常建立连接-三次握手：

* 客户端发送SYN包到服务器，并进入SYN\_SENT状态，等待服务器确认。
* 服务器收到SYN包，反馈给客户端一个SYN+ACK包，此时服务器进入SYN\_RECV状态。
* 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK，客户端和服务器同时进入ESTABLISHED（TCP连接成功状态），完成三次握手。

## TCP正常关闭连接-四次挥手：

* 关闭请求方（比如客户端）向另一方发送（比如服务器）一个带有FIN附加标记的报文段；
* 服务器收到FIN报文段之后：
  * 不立即用FIN报文段回复客户端，
  * 先向客户端发送一个确认序号ACK，
  * 同时通知自己的相应的应用程序：对方要求关闭连接，使应用程序做相应的清理工作；
* 服务器的应用程序清理工作完成后，向客户端发送一个FIN报文段；
* 客户端收到这个FIN报文段后，向服务器发送一个ACK，表示连接彻底释放。

## 2MSL

MSL

Maximum Segment Lifetime 报文最大生存时间：

* 是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。
* tcp报文（segment）是ip数据报（datagram）的数据部分，
  * 而ip头中有一个TTL（time to live 生存时间）域，
  * 生存时间是由源主机设置初始值但不是存的具体时间，而是存储了一个ip数据报可以经过的最大路由数，
    * 每经过一个处理他的路由器此值就减1，
    * 当此值为0则数据报将被丢弃，同时发送ICMP报文通知源主机。
* 规定MSL为2分钟，实际应用中常用的是30秒，1分钟和2分钟等。

2MSL即两倍的MSL，TCP的`TIME_WAIT`状态也称为2MSL等待状态，当TCP的一端发起主动关闭，在发出最后一个ACK包后，即第3次握手完成后发送了第四次握手的ACK包后就进入了`TIME_WAIT`状态，必须在此状态上停留两倍的MSL时间，等待2MSL时间主要目的是怕最后一个ACK包对方没收到，那么对方在超时后将重发第三次握手的FIN包，主动关闭端接到重发的FIN包后可以再发一个ACK应答包。在`TIME_WAIT`状态时两端的端口不能使用，要等到2MSL时间结束才可继续使用。当连接处于2MSL等待阶段时任何迟到的报文段都将被丢弃。不过在实际应用中可以通过设置SO\_REUSEADDR选项达到不必等待2MSL时间结束再使用此端口。

TTL与MSL是有关系的但不是简单的相等的关系，MSL要大于等于TTL。

### 同时打开
![](/assets/同时打开.png)

### 同时关闭
![](/assets/同时关闭.png)

